# 上下文

- 目标：修复网关 P0 问题（限流窗口失效、流式结束协议不一致、流式 token/成本估算偏差、渠道变更缓存漂移、格式与小瑕疵）。
- 范围：`lib/cache/kv.ts`、`lib/stats/tracker.ts`、`lib/llm/stream.ts`、`lib/llm/types.ts`、`lib/balancer/index.ts`、`app/api/**`。
- 约束：保持实现简单（KISS），不引入新依赖；对外 Responses 流式 `delta` 采用 `string`。

# 计划（执行版）

1. 修复限流计数 TTL：`kv.increment()` 支持传入 ttl 并在限流中每次写入携带 ttl。
2. 规范流式结束信号：按 `targetFormat` 处理 `[DONE]`，避免向非 OpenAI Chat 客户端输出 `[DONE]`。
3. 修复流式 token 估算：当上游不提供 usage 时，对 delta 做增量估算并累加到 `ctx.outputTokens`。
4. 修复 Responses 流式 delta 类型：解析兼容 `string | { text }`，输出统一为 `string`。
5. 修复渠道变更缓存漂移：渠道更新/删除后按 `channelId` 失效相关 group 缓存。
6. 修复格式与小瑕疵：修正 `apiKeyHash` 缩进、`checkQuota` 未使用参数。

